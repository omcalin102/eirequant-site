---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

import ModelPicks from "../components/cards/ModelPicks.tsx";
import GreeksMini from "../components/cards/GreeksMini.tsx";
import SectorHeatMini from "../components/cards/SectorHeatMini.tsx";
import TickerLeadersMini from "../components/cards/TickerLeadersMini.tsx";
import TopDriversMini from "../components/cards/TopDriversMini.tsx";

const posts = (await getCollection("posts"))
  .sort((a,b)=>a.data.date<b.data.date?1:-1)
  .slice(0,3);
---
<BaseLayout
  title="EireQuant"
  description="A next-generation quantitative research platform — blending model families, portfolios, and real-time pipelines into one open showcase.">

  <!-- PAGE GRID -->
  <div class="home-grid">
    <!-- Left rail -->
    <aside class="rail rail-left">
      <div class="panel">
        <div class="card-head">
          <div class="card-title muted">Today</div>
          <div id="today-date" class="date">—</div>
        </div>

        <div class="kicker">Headlines</div>
        <ul id="headlines" class="list pill-grid" aria-live="polite">
          <li class="muted">No headlines.</li>
        </ul>

        <div class="kicker">Recent blog</div>
        <ul class="list">
          {posts.map(p => (
            <li><a class="pill" href={`/blog/${p.slug}/`}>{p.data.title}</a></li>
          ))}
          <li><a class="pill" href="/blog/">See all posts →</a></li>
        </ul>

        <ul class="list small">
          <li><a class="pill" href="/pipelines/live/">Pipeline Notes</a></li>
          <li><a class="pill" href="/models/eqx-m1/">Model Update</a></li>
        </ul>
      </div>
    </aside>

    <!-- Center column -->
    <section class="center">
      <div class="hero panel">
        <h1 class="brandtitle">EireQuant</h1>
        <p class="lede">
          EireQuant is an end-to-end quantitative research system that turns raw market information into
          <strong>audited, risk-aware decisions</strong>. It ingests prices, options flow, news/sentiment, and a few fundamentals; builds
          <strong>calibrated</strong> models that can admit uncertainty; and converts those views into portfolios with explicit constraints—then
          stress-tests them under realistic frictions.
        </p>
        <p class="hint">
          On this site you’ll see <strong>daily model picks</strong>, a <strong>portfolio Greeks</strong> snapshot, <strong>sector heat</strong>, and live
          <strong>leaders & drivers</strong> from the pipeline. Explore <strong>model families</strong> (Core, Sentinel, Experimental), read
          <strong>model cards</strong> like EQX-M1, and use <strong>Compare</strong> to benchmark models across regimes.
        </p>
        <div class="cta">
          <a href="/models/" class="btn primary">Explore Models</a>
          <a href="/blog/" class="btn">Read Blog</a>
        </div>
      </div>

      <!-- Split into three vertical panels -->
      <div class="panel">
        <div class="muted">Today · <span id="today-date-2">—</span></div>
        <h3 class="card-title">Model Picks</h3>
        <ModelPicks client:load />
      </div>

      <div class="panel">
        <h3 class="card-title">Portfolio Greeks</h3>
        <GreeksMini client:load />
      </div>

      <div class="panel">
        <h3 class="card-title">Sector Heat</h3>
        <SectorHeatMini client:load />
      </div>
    </section>

    <!-- Right rail -->
    <aside class="rail rail-right">
      <div class="panel">
        <h3 class="hsmall card-title">Top Tickers</h3>
        <TickerLeadersMini client:load />
      </div>

      <div class="panel">
        <h3 class="hsmall card-title">Top Drivers</h3>
        <TopDriversMini client:load />
      </div>

      <div class="panel">
        <h3 class="hsmall card-title">Spotlight Sector</h3>
        <div id="spot-sector" class="muted">— —</div>
      </div>

      <div class="panel">
        <h3 class="hsmall card-title">Go Deeper</h3>
        <ul class="list small">
          <li><a class="pill" href="/pipelines/live/">Live Pipeline →</a></li>
          <li><a class="pill" href="/models/eqx-m1/">EQX-M1 Model Card →</a></li>
          <li><a class="pill" href="/compare/">Compare Benchmarks & Models →</a></li>
        </ul>
      </div>
    </aside>
  </div>

  <script type="module">
    const baseHref = () => (document.querySelector("base")?.getAttribute("href") || "/").replace(/\/+$/, "/");
    const url = (p) => (baseHref() + String(p).replace(/^\//,"")).replace(/([^:]\/)\/+/g,"$1");
    const $ = (s)=>document.querySelector(s);
    const list = (el, rows)=>{ el.innerHTML = rows.map(r=>`<li>${r}</li>`).join("") };
    const fmt = (x)=> x==null || !isFinite(Number(x)) ? "—" : Number(x).toFixed(2);

    async function j(p){ const r=await fetch(url(p),{cache:"no-cache"}); if(!r.ok) throw new Error(p); return r.json(); }

    function score(s){
      if (typeof s?.contribution === "number") return s.contribution;
      if (typeof s?.omega === "number") return Math.log(Math.max(1e-9, s.omega));
      if (typeof s?.median_beta === "number") return -s.median_beta;
      if (typeof s?.ret === "number") return s.ret;
      if (typeof s?.score === "number") return s.score;
      if (typeof s?.value === "number") return s.value;
      return 0;
    }

    try {
      const latest = (await j("/data/daily/latest.json").catch(()=>null)) ?? (await j("/data/latest.json").catch(()=>null));
      const date = latest?.date ?? "—";
      $("#today-date").textContent = date;
      $("#today-date-2").textContent = date;

      // Headlines
      j(`/data/news/${date}.json`).then(n=>{
        const arr = Array.isArray(n?.headlines) ? n.headlines : (Array.isArray(n) ? n : []);
        if (arr.length) list($("#headlines"), arr.slice(0,6).map(h=>{
          const t = h?.title ?? String(h); const u = h?.url ?? "#";
          return `<a class="pill" href="${u}">${t}</a>`;
        }));
      }).catch(()=>{});

      // Spotlight (primary)
      j("/data/models/eqx-m1/sector_of_month.json").then(s=>{
        if (s?.sector) $("#spot-sector").textContent = `${s.sector} — ${fmt(s.score ?? s.value ?? s.strength)}`;
      }).catch(()=>{});

      // Fallback: derive from daily sector health
      setTimeout(async ()=>{
        const el = $("#spot-sector");
        if (el && el.textContent.trim() === "— —" && date && date !== "—") {
          try {
            const d = await j(`/data/daily/${date}/sector_health.json`);
            const sectors = Array.isArray(d?.sectors) ? d.sectors : [];
            const leaders = Array.isArray(d?.leaders) ? d.leaders : [];
            const combined = [
              ...sectors.map(s => ({ name: s.sector ?? s.name, _score: score(s) })),
              ...leaders.map(s => ({ name: s.sector ?? s.name, _score: score(s) })),
            ].filter(x => x && x.name && x.name !== "Unknown" && isFinite(x._score) && x._score !== 0);
            combined.sort((a,b)=>b._score - a._score);
            if (combined.length) el.textContent = `${combined[0].name} — ${fmt(combined[0]._score)}`;
          } catch {}
        }
      }, 0);

    } catch(e){ console.warn(e); }
  </script>
</BaseLayout>

<style>
  /* page-scoped layout: fits within .page (1120px max) */
  .home-grid{
    display:grid;
    grid-template-columns: 260px 1fr 260px; /* left rail | center | right rail */
    gap:1rem;
    align-items:start;
  }
  @media(min-width:1025px){
    .home-grid{ grid-template-columns: 260px minmax(520px,1fr) 260px; }
  }
  @media(max-width:1000px){
    .home-grid{ grid-template-columns: 1fr; }
    .rail-left,.rail-right{ max-width:none; width:auto; }
  }

  .rail{ display:grid; gap:1rem; }
  .rail-left{ width:100%; max-width:260px; }
  .rail-right{ width:100%; max-width:260px; }

  .panel{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:1rem; box-shadow:0 6px 18px rgba(0,0,0,.05); }

  .center{ display:grid; gap:1rem; }
  .brandtitle{ font-size:clamp(1.8rem,3.2vw,2.4rem); margin:0; }
  .lede{ color:#444; margin:.5rem 0 .25rem; }

  /* Fix buttons: no stretch, centered content, consistent sizing */
  .cta{ display:flex; gap:.6rem; flex-wrap:wrap; align-items:center; }
  .cta > .btn{
    display:inline-flex !important;
    align-items:center; justify-content:center;
    width:auto !important;
    flex:0 0 auto !important;
    min-width:140px; padding:.7rem 1rem;
    white-space:nowrap; text-align:center;
  }

  .muted{ color:var(--muted); }
  .kicker{ margin:.75rem 0 .25rem; font-size:.85rem; font-weight:700; color:#333; text-transform:uppercase; letter-spacing:.04em; }
  .date{ font-weight:600; margin:.15rem 0 .5rem; }
  .list{ list-style:none; margin:.25rem 0 0; padding:0; display:grid; gap:.35rem; }
  .list.small li{ font-size:.95rem; }
  .hsmall{ font-size:1rem; margin:.1rem 0 .6rem; }
</style>
