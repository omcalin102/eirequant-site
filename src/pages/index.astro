---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

import ModelPicks from "../components/cards/ModelPicks.tsx";
import GreeksMini from "../components/cards/GreeksMini.tsx";
import SectorHeatMini from "../components/cards/SectorHeatMini.tsx";
import TickerLeadersMini from "../components/cards/TickerLeadersMini.tsx";
import TopDriversMini from "../components/cards/TopDriversMini.tsx";

const posts = (await getCollection("posts"))
  .sort((a,b)=>a.data.date<b.data.date?1:-1)
  .slice(0,4);
---

<BaseLayout title="EireQuant" description="Independent, live-hosted quantitative investment research using explainable models and audited data paths.">

  <!-- LEFT RAIL (slot) -->
  <Fragment slot="left">
    <div class="panel tight">
      <div class="card-head">
        <div class="card-title muted">Today</div>
        <div id="today-date" class="date">—</div>
      </div>

      <div class="kicker">Recent blog</div>
      <ul class="news-list">
        {posts.map(p => (
          <li class="news-item">
            <a class="news-link" href={`/blog/${p.slug}/`}>{p.data.title}</a>
            <div class="news-meta">By {p.data.author ?? "Oisin McAlinden"}</div>
          </li>
        ))}
      </ul>
      <a class="pill subtle" href="/blog/">See all posts →</a>
    </div>

    <div class="panel tight">
      <h3 class="hsmall card-title">How to read the data</h3>
      <dl class="explainer">
        <dt>Delta</dt><dd>Sensitivity to market moves. Positive delta means the portfolio tends to rise when the index rises.</dd>
        <dt>Gamma</dt><dd>How fast delta changes. Higher gamma means the portfolio’s sensitivity can shift quickly in volatile markets.</dd>
        <dt>Vega</dt><dd>Exposure to volatility. Positive vega benefits when implied volatility rises; negative vega prefers calm markets.</dd>
        <dt>Theta</dt><dd>Time decay. Negative theta loses carry through time; around zero is neutral cost of carry.</dd>
        <dt>Omega</dt><dd>Odds-like risk/reward. Above 1.0 means gains outweigh losses on average; higher is a steadier edge.</dd>
        <dt>Sharpe / Sortino</dt><dd>Return per unit of risk. Sharpe uses total volatility; Sortino focuses on downside only.</dd>
        <dt>CAGR</dt><dd>Compounded annual growth rate over the selected window.</dd>
        <dt>Vol</dt><dd>Annualized volatility (how bumpy the ride is).</dd>
        <dt>Max DD</dt><dd>Worst peak-to-trough drawdown. Lower in magnitude is easier to live with.</dd>
        <dt>Regime</dt><dd>Model’s current macro/vol state label that governs its playbook.</dd>
        <dt>Confidence</dt><dd>Internal quality/fit score. Higher confidence: signals are clearer and more consistent.</dd>
      </dl>
    </div>
  </Fragment>

  <!-- CENTER COLUMN (default slot) -->
  <div class="panel hero hero-centered">
    <div class="hero-inner">
      <img
        class="hero-wordmark"
        src="/brand/logo-wordmark.png"
        alt="EireQuant"
        width="416"
        height="128"
        loading="eager"
        decoding="async"
      />

      <p class="hero-intro">
        EireQuant is a live research platform where I design and build financial predictive models and systems that aim to maximise returns while managing risk.
        The site showcases model performance, project development, and market insights through daily updates and in-depth analysis.
      </p>

      <a href="/pipelines/sim/" class="btn primary hero-btn">About the project</a>
    </div>
  </div>

  <div class="mini-grid">
    <a class="mini card" href="/pipelines/live/">
      <h3 class="mini-title">Live Data</h3>
      <p class="mini-copy">Daily runs, selections, Greeks, sector health, and policy traces.</p>
    </a>
    <a class="mini card" href="/compare/">
      <h3 class="mini-title">Compare Models</h3>
      <p class="mini-copy">Overlay paths by window; review CAGR, drawdown, and Sharpe at a glance.</p>
    </a>
    <a class="mini card" href="/about/">
      <h3 class="mini-title">Who I am</h3>
      <p class="mini-copy">Background, approach, and how to get in touch.</p>
    </a>
  </div>

  <div class="panel">
    <div class="muted">Today · <span id="today-date-2">—</span></div>
    <h3 class="card-title">Model Picks</h3>
    <ModelPicks client:load />
  </div>

  <div class="panel">
    <h3 class="card-title">Portfolio Greeks</h3>
    <GreeksMini client:load />
  </div>

  <div class="panel">
    <h3 class="card-title">Sector Heat</h3>
    <SectorHeatMini client:load />
  </div>

  <!-- RIGHT RAIL (slot) -->
  <Fragment slot="right">
    <div class="panel">
      <h3 class="hsmall card-title">Explore Series</h3>
      <div class="series-grid">
        <a class="series" href="/models/series/eq-core/" aria-label="Explore Core series">
          <img src="/brand/EQC-Rectangle.png" alt="EireQuant Core" loading="lazy" />
        </a>
        <a class="series" href="/models/series/eq-sentinel/" aria-label="Explore Sentinel series">
          <img src="/brand/EQS-Rectangle.png" alt="EireQuant Sentinel" loading="lazy" />
        </a>
        <a class="series" href="/models/series/eq-tbd/" aria-label="Explore Experimental series">
          <img src="/brand/EQX-Rectangle.png" alt="EireQuant Experimental" loading="lazy" />
        </a>
      </div>
    </div>

    <!-- Top Tickers (kept vertical via script below) -->
    <div class="panel top-tickers" id="top-tickers-panel">
      <h3 class="hsmall card-title">Top Tickers</h3>
      <div class="tickers-vertical">
        <TickerLeadersMini client:load />
      </div>
    </div>

    <div class="panel">
      <h3 class="hsmall card-title">Top Drivers</h3>
      <TopDriversMini client:load />
    </div>

    <div class="panel">
      <h3 class="hsmall card-title">Spotlight Sector</h3>
      <div id="spot-sector" class="muted">— —</div>
    </div>

    <div class="panel">
      <h3 class="hsmall card-title">Go Deeper</h3>
      <ul class="list small">
        <li><a class="pill" href="/pipelines/live/">Live Pipeline →</a></li>
        <li><a class="pill" href="/models/eqx-m1/">EQX-M1 Model Card →</a></li>
        <li><a class="pill" href="/compare/">Compare Benchmarks & Models →</a></li>
      </ul>
    </div>
  </Fragment>
</BaseLayout>

<script type="module">
  const baseHref = () => (document.querySelector("base")?.getAttribute("href") || "/").replace(/\/+$/, "/");
  const url = (p) => (baseHref() + String(p).replace(/^\//,"")).replace(/([^:]\/)\/+/g,"$1");
  const $ = (s)=>document.querySelector(s);
  const fmt = (x)=> x==null || !isFinite(Number(x)) ? "—" : Number(x).toFixed(2);
  async function j(p){ try{ const r=await fetch(url(p),{cache:"no-cache"}); if(!r.ok) return null; return await r.json(); }catch{ return null; } }

  (async () => {
    const latest = (await j("/data/daily/latest.json")) ?? (await j("/data/latest.json"));
    const date = latest?.date ?? "—";
    $("#today-date").textContent = date;
    $("#today-date-2").textContent = date;

    const sp = await j("/data/models/eqx-m1/sector_of_month.json");
    if (sp?.sector) { $("#spot-sector").textContent = `${sp.sector} — ${fmt(sp.score ?? sp.value ?? sp.strength)}`; return; }
    if (date && date !== "—") {
      const d = await j(`/data/daily/${date}/sector_health.json`);
      const arr = Array.isArray(d?.leaders) ? d.leaders : [];
      if (arr.length) $("#spot-sector").textContent = `${arr[0]?.sector ?? arr[0]?.name ?? "—"} — ${fmt(arr[0]?.score ?? arr[0]?.value)}`;
    }
  })();

  /* Enforce Top Tickers 1×N layout (in case the component renders 2 columns internally) */
  function forceTopTickersSingleColumn(root) {
    if (!root) return;
    const nodes = root.querySelectorAll('*');
    nodes.forEach(el => {
      const cs = getComputedStyle(el);
      if (cs.display === 'grid') {
        el.style.gridTemplateColumns = '1fr';
        el.style.gridAutoFlow = 'row';
      }
      if (cs.display === 'flex') {
        el.style.flexDirection = 'column';
        el.style.flexWrap = 'nowrap';
        el.style.alignItems = 'stretch';
      }
    });
  }
  function attachTopTickersNormalizer() {
    const panel = document.getElementById('top-tickers-panel');
    if (!panel) return;
    forceTopTickersSingleColumn(panel);
    const mo = new MutationObserver(() => forceTopTickersSingleColumn(panel));
    mo.observe(panel, { childList: true, subtree: true, attributes: true });
    window.addEventListener('load', () => forceTopTickersSingleColumn(panel));
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', attachTopTickersNormalizer);
  } else {
    attachTopTickersNormalizer();
  }
</script>

<style>
  /* Panels & rails */
  .panel{ background:#fff; border:1px solid var(--border); border-radius:12px; padding:1rem; box-shadow:0 6px 18px rgba(0,0,0,.05); }
  .panel.tight{ padding:.75rem; }
  .rail{ display:grid; gap:1rem; }

  /* HERO — centered stack with clear spacing */
  .hero{ padding:1.6rem 1.4rem; }
  .hero-centered .hero-inner{
    max-width:900px;
    margin:0 auto;
    display:flex;
    flex-direction:column;
    align-items:center;
    text-align:center;
    gap:1.4rem;
    min-height:360px;
    justify-content:center;
  }
  .hero-wordmark{
    width:min(416px, 86%);
    height:auto;
    display:block;
  }
  .hero-intro{
    color:#2f2f2f;
    line-height:1.62;
    font-size:clamp(1.02rem, 1.1vw, 1.14rem);
    max-width:72ch;
    margin:0 auto; /* ensure text block stays centered */
  }
  .btn{
    display:inline-flex; align-items:center; justify-content:center;
    padding:.95rem 1.35rem;
    border-radius:10px; border:1px solid var(--border);
    background:#fafafa; font-weight:600;
  }
  .btn.primary{ background:#0E3B2D; color:#fff; border-color:#0E3B2D; }
  .hero-btn{
    width:clamp(260px, 46%, 440px);
    max-width:90%;
    font-size:1.06rem;
    margin:0 auto;           /* <<< keep the CTA perfectly centered */
  }

  /* Mini cards (center column) */
  .mini-grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:1rem; }
  @media(max-width:820px){ .mini-grid{ grid-template-columns: 1fr; } }
  .mini.card{ text-decoration:none; color:inherit; border:1px solid var(--border); border-radius:12px; padding:14px; background:#fff; }
  .mini.card:hover{ box-shadow:0 6px 18px rgba(0,0,0,.06); }
  .mini-title{ margin:.1rem 0 .35rem; font-size:1.05rem; }
  .mini-copy{ margin:0; color:#555; }

  /* Left-rail list */
  .news-list{ list-style:none; margin:.5rem 0 0; padding:0; display:grid; gap:.6rem; }
  .news-item{ border:1px solid var(--border); border-radius:10px; padding:.55rem .65rem; background:#fff; }
  .news-link{ color:#0b0b0b; text-decoration:none; font-weight:600; line-height:1.25; display:block; }
  .news-link:hover{ text-decoration:underline; }
  .news-meta{ font-size:.85rem; color:#666; margin-top:.2rem; }
  .pill.subtle{ margin-top:.6rem; display:inline-block; }

  /* Right-rail series */
  .series-grid{ display:grid; gap:.6rem; }
  .series img{ width:100%; height:auto; display:block; border-radius:10px; border:1px solid var(--border); background:#fff; }
  .series img:hover{ box-shadow:0 8px 18px rgba(0,0,0,.07); }

  /* Optional: layout hint for tickers wrapper; JS enforces regardless */
  .top-tickers .tickers-vertical{ display:grid; grid-template-columns: 1fr; gap:.5rem; }

  .kicker{ margin:.35rem 0 .35rem; font-size:.85rem; font-weight:700; color:#333; text-transform:uppercase; letter-spacing:.04em; }
  .card-title{ margin:.15rem 0 .4rem; }
  .hsmall{ font-size:1rem; margin:.1rem 0 .6rem; }
  .muted{ color:var(--muted); }
  .date{ font-weight:600; }

  /* Explainer list */
  .explainer{ margin:0; }
  .explainer dt{ font-weight:700; margin-top:.35rem; }
  .explainer dd{ margin:.1rem 0 .25rem 0; color:#4b4b4b; }
</style>
