---
import modelSeries from "../lib/modelSeries";
const pathname = Astro.url.pathname;

// Build a map: seriesSlug -> [{title, slug}]
const seriesToMarks = Object.fromEntries(
  modelSeries.map(s => [
    s.slug,
    s.marks.map(m => ({
      title: m.title,
      href: `/models/${m.slug}/`
    }))
  ])
);

// Helper for active link styling
function isActive(href: string) {
  return pathname === href || pathname.startsWith(href);
}
---
<nav class="site-nav">
  <div class="nav-inner">
    <a href="/" class="brand">
      <img src="/brand/logo-wordmark.png" alt="EireQuant" class="brand-mark" />
      <span class="sr-only">EireQuant</span>
    </a>

    <button class="hamburger" aria-label="Open menu" aria-expanded="false" id="navToggle">
      <span></span><span></span><span></span>
    </button>

    <ul class="nav-links" id="navLinks">
      <li class={`top-link ${isActive("/") ? "active" : ""}`}><a href="/">Home</a></li>

      <!-- MODELS DROPDOWN (two-column) -->
      <li class="top-link has-dropdown" data-menu="models">
        <button class="dropdown-trigger" aria-haspopup="true" aria-expanded="false">Models <span class="caret">▾</span></button>
        <div class="dropdown models-dropdown" role="menu" aria-label="Models">
          <div class="models-left" id="modelsLeft">
            {modelSeries.map((s, i) => (
              <button
                type="button"
                class={`series-item ${i === 0 ? "current" : ""}`}
                data-series={s.slug}
                aria-controls={`panel-${s.slug}`}
              >
                <span class="series-title">{s.title}</span>
                <span class="series-sub">{s.subtitle}</span>
              </button>
            ))}
          </div>
          <div class="models-right">
            {modelSeries.map((s, i) => (
              <div
                class={`marks-panel ${i === 0 ? "current" : ""}`}
                id={`panel-${s.slug}`}
                data-series={s.slug}
              >
                <div class="panel-header">
                  <a class="series-link" href={`/models/series/${s.slug}/`}>{s.title}</a>
                </div>
                <ul class="marks-list">
                  {seriesToMarks[s.slug]?.map(m => (
                    <li><a href={m.href}>{m.title}</a></li>
                  ))}
                </ul>
              </div>
            ))}
          </div>
        </div>
      </li>

      <!-- PORTFOLIOS -->
      <li class={`top-link ${isActive("/portfolios/") ? "active" : ""}`}><a href="/portfolios/">Portfolios</a></li>

      <!-- COMPARE -->
      <li class={`top-link ${isActive("/compare") ? "active" : ""}`}><a href="/compare">Compare</a></li>

      <!-- PIPELINES DROPDOWN -->
      <li class="top-link has-dropdown" data-menu="pipelines">
        <button class="dropdown-trigger" aria-haspopup="true" aria-expanded="false">Pipelines <span class="caret">▾</span></button>
        <div class="dropdown simple-dropdown" role="menu" aria-label="Pipelines">
          <ul>
            <li><a href="/pipelines/live/">Live Pipeline</a></li>
            <li><a href="/pipelines/sim/">Simulation Pipeline</a></li>
          </ul>
          <div class="dropdown-foot">
            <a href="/pipelines/">Overview</a>
          </div>
        </div>
      </li>

      <!-- BLOG / ABOUT / CONTACT -->
      <li class={`top-link ${isActive("/blog/") ? "active" : ""}`}><a href="/blog/">Blog</a></li>
      <li class={`top-link ${isActive("/about") ? "active" : ""}`}><a href="/about">About</a></li>
      <li class={`top-link ${isActive("/contact/") ? "active" : ""}`}><a href="/contact/">Contact</a></li>
    </ul>
  </div>

  <script is:inline>
    // Mobile toggle
    const toggle = document.getElementById('navToggle');
    const links = document.getElementById('navLinks');
    if (toggle && links) {
      toggle.addEventListener('click', () => {
        const open = links.classList.toggle('open');
        toggle.setAttribute('aria-expanded', String(open));
      });
    }

    // Open dropdown on click/focus (desktop)
    for (const host of document.querySelectorAll('.has-dropdown')) {
      const btn = host.querySelector('.dropdown-trigger');
      const dd  = host.querySelector('.dropdown');
      if (!btn || !dd) continue;

      const open = (v) => {
        dd.classList.toggle('open', v);
        btn.setAttribute('aria-expanded', String(v));
      };

      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        open(!dd.classList.contains('open'));
      });

      btn.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') open(false);
      });

      document.addEventListener('click', (e) => {
        if (!host.contains(e.target)) open(false);
      });

      // Models two-column switching
      if (host.dataset.menu === 'models') {
        const left = host.querySelector('#modelsLeft');
        left?.addEventListener('mouseover', (e) => {
          const b = e.target.closest('.series-item');
          if (!b) return;
          const series = b.dataset.series;
          // left highlight
          left.querySelectorAll('.series-item').forEach(el => el.classList.toggle('current', el === b));
          // right panel switch
          dd.querySelectorAll('.marks-panel').forEach(p => {
            p.classList.toggle('current', p.dataset.series === series);
          });
        });
        left?.addEventListener('focusin', (e) => {
          const b = e.target.closest('.series-item');
          if (!b) return;
          const series = b.dataset.series;
          left.querySelectorAll('.series-item').forEach(el => el.classList.toggle('current', el === b));
          dd.querySelectorAll('.marks-panel').forEach(p => p.classList.toggle('current', p.dataset.series === series));
        });
      }
    }
  </script>
</nav>

<style>
  .site-nav { position: sticky; top: 0; z-index: 50; background: var(--bg-50,#fff); border-bottom: 1px solid rgba(0,0,0,.06); }
  .nav-inner { display:flex; align-items:center; justify-content:space-between; max-width:1100px; margin:0 auto; padding:0.75rem 1rem; }
  .brand { display:flex; align-items:center; gap:.5rem; }
  .brand-mark { height:28px; }
  .hamburger { display:none; background:none; border:0; padding:.5rem; cursor:pointer; }
  .hamburger span { display:block; width:22px; height:2px; background:#111; margin:4px 0; }
  .nav-links { display:flex; gap:1rem; align-items:center; }
  .nav-links.open { display:block; }
  .top-link > a, .top-link > button.dropdown-trigger { font-weight:600; color:#111; padding:.5rem .25rem; border:0; background:none; cursor:pointer; }
  .top-link.active > a { color: var(--brand, #0E3B2D); }
  .caret { margin-left:.25rem; opacity:.7; }
  .has-dropdown { position:relative; }
  .dropdown { position:absolute; top:100%; left:0; background:#fff; border:1px solid rgba(0,0,0,.08); box-shadow:0 10px 30px rgba(0,0,0,.08); border-radius:12px; padding:.5rem; display:none; }
  .dropdown.open { display:flex; }
  .simple-dropdown { flex-direction:column; min-width:220px; }
  .simple-dropdown ul { list-style:none; margin:0; padding:.25rem; }
  .simple-dropdown li a { display:block; padding:.5rem .75rem; border-radius:8px; }
  .simple-dropdown li a:hover { background:#f4f4f4; }
  .simple-dropdown .dropdown-foot { padding:.25rem .5rem .5rem; border-top:1px solid #eee; margin-top:.25rem; }
  /* Models two-column */
  .models-dropdown { gap:0; padding:.75rem; }
  .models-left { width:240px; border-right:1px solid #eee; padding:.25rem; display:flex; flex-direction:column; gap:.25rem; }
  .series-item { text-align:left; border:0; background:transparent; padding:.5rem .75rem; border-radius:10px; cursor:pointer; }
  .series-item.current, .series-item:hover { background:#f6f7f7; }
  .series-title { display:block; font-weight:700; }
  .series-sub { display:block; font-size:.85rem; color:#666; }
  .models-right { min-width:260px; padding:.25rem .5rem; }
  .marks-panel { display:none; min-width:260px; }
  .marks-panel.current { display:block; }
  .panel-header { padding:.25rem .25rem .5rem; border-bottom:1px solid #eee; margin-bottom:.5rem; }
  .marks-list { list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:.25rem; }
  .marks-list a { display:block; padding:.5rem .5rem; border-radius:8px; }
  .marks-list a:hover { background:#f4f4f4; }
  /* Mobile */
  @media (max-width: 820px){
    .hamburger{display:block;}
    .nav-links{display:none; position:absolute; left:0; right:0; top:56px; background:#fff; border-bottom:1px solid #eee; flex-direction:column; padding:.5rem 1rem 1rem;}
    .has-dropdown .dropdown{ position:static; box-shadow:none; border:0; border-radius:0; display:none; padding:0; }
    .has-dropdown.open .dropdown{ display:block; }
    .models-dropdown{ display:block; }
    .models-left{ width:100%; border:0; }
    .models-right{ padding:0; }
    .panel-header{ display:none; }
    .marks-panel{ display:block; }
  }
  .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0; }
</style>
